<!--
*********************************************************************************************************************************************************
*********************************************************************************************************************************************************


    Code for experiment on statistical interpretation
    CC-BY-SA Lonni Besançon, Jouni Helske, 2019


*********************************************************************************************************************************************************
*********************************************************************************************************************************************************
-->
<!DOCTYPE html>
<html>
<head>
    <script src="jquery-3.3.1.js"></script>

    <script src="seedrandom.min.js"></script>
    <!--<script src="//cdnjs.cloudflare.com/ajax/libs/seedrandom/2.4.4/seedrandom.min.js"></script>-->
    <meta charset="UTF-8" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="index.css">
    <title>Confidence visualization 2 </title>
</head>

<body>
    <section id="consent">
        <h1>Consent to Participate in a Research Experiment</h1><br/>

        <h4>The Research Project</h4>
        <i>Principal Investigators:</i> <a href="http://weber.itn.liu.se/~jouhe21">Jouni Helske</a> and <a href="http://lonnibesancon.me">Lonni Besançon</a>, Linköping University, Sweden.<br/><br/>
        <i>Title of the research experiment:</i> Visualizing confidence, <b>Part 2</b>

        <h4>Eligibility</h4>
        You may only take part in this study if:
        <ol>
            <li> You understand English,</li>
            <li> You are at least 18 years old,</li>
            <li> Have at least a basic understanding of hypothesis testing and confidence intervals,</li>
            <li> You use statistical tools in your research projects,</li>
            <li> You are not using a handheld device such as tablet or phone to fill out the survey. </li>
        </ol>

        <p>If you believe you may not be eligible, you can withdraw from the study without having to justify why. <br/>
        Alternatively, you can ask for clarification of the eligibility criteria above before you make your decision by contacting either of the two investigators.</p>
        <p> Should you wish to take part in this research experiment, please read the following information carefully.</p>

        <h4>Aim of Research</h4>
        The goal of this experiment is to study the impact of visualization on statistical inferences.

        <h4>Procedure, Data Collection, and Use of Gathered Data</h4>
        <p> The study is only run online through this webpage. Based on pilot-studies, we expect it to last less than 15 minutes. You can take a break at any moment,
            but for technical reasons you cannot close the browser window containing the survey without terminating the study. In each page of the main study
            you will be presented a single question. It is not possible to go back to the previous questions or skip questions.


        <p> You will be asked, at the beginning of the experiment, to fill in some demographic information but you will not be asked to provide any identifiable information.
            We will not save any information about your location, software, or hardware.
            Therefore no one, including the researcher, will be able to identify you from your responses.
             Your responses will be used and analyzed by the researchers as part of a dataset generated by other participants who complete the study.
             The findings of the study may be presented in a written publication and/or presented at conferences in future, and the study dataset may be shared online to promote open science.</p>

             <p>
                 Your information will be dealt with in accordance with The Freedom of the Press Act and The Public Access to Information and Secrecy Act (2009: 400, OSL).
                 According to Linköping University your information will be subject to secrecy provisions in accordance with Chapter 24
                 Section 8 OSL and Section 7 of the Public Access to Information and Secrecy Ordinance (2009: 641).</p>

        <h4>Benefits, Compensation, and Risks</h4>

        <p>There will be no direct benefits for you taking part in the research, though you may gain some insight into how the different visualizations you will see could
            be beneficial for your work. Your responses will be a very helpful contribution to research through furthering our understanding of people's perception of statistical results.
             You can, after the study is over, contact the principal investigators to learn about the outcome of this experiment.</p>

        <p>There will be no monetary compensation for participating in this study.</p>

        <p>As the experiment does not involve any action other than the ones involved in the daily use of a computer, we expect that this study does not
            present any other risk than the minimal risk of using a computer.</p>


        <h4>Contact</h4>

        Should you have any question, please contact the main investigators at this address: jouni[_dot_]helske[-at-]liu.se

        <br/>
        <br/>
        <input id="consentButton" type="button" value="I consent to participate in this research experiment " onclick="onConsent()" /><br/>
    </section>
    <section id="initialdiv" style="display:none">
        <h1>Assessing the effects of representation styles for statistical inference</h1>
        <div id="explanations">

<h4>Goal of the study</h4>
<p> The goal of this experiment is to study whether various
    representation styles of the results from a simple statistical analysis have an effect on the interpretation of these results.</p>

<h4>Background story</h4>
<p> A random sample of 50 adults from Sweden were prescribed a new medication for one week.
    Another random sample of 50 adults were assigned to a control group.
    Based on these measurements from these two samples, you are trying to figure out whether the
    medication decreases the body weight compared to the control group who were given placebo.
    Note that this is just an illustrative story, you can think a similar example from your own research area.
</p>

<h4>Your task</h4>
<p> In this experiment you will be presented results from multiple independent trials
    (each consisting of 50+50 participants)
    like the one described above, with various representation styles of the results.
    Your goal is to assess whether the medication decreases the body weight compared to the control group. </p>
<br/>
        </div>
        <form>
        <div id="demographic">

            <p>
            <label for="previousStudy">Have you participated in our previous study (<a target="_blank" rel="noopener noreferrer" href="http://webstaff.itn.liu.se/~jouhe21/experiment/">http://webstaff.itn.liu.se/~jouhe21/experiment/</a>):</label>
            <select id = "previousStudy">
                <option value="null"></option>
                 <option value="Yes">Yes</option>
                 <option value="No">No</option>
             </select>
            </p>
                <p>
                    <label for="participantAge">Your age:</label>
                    <input type = "text" id = "participantAge" value = "" >
                </p>
                <p>
                    <label for="participantExpertise">Field of Expertise:</label>
                    <input type = "text" id = "participantExpertise" value = "" >
                </p>
                <p>
                    <label for="participantLevel">Highest academic degree obtained: </label>
                    <select id="participantLevel">
                        <option value="null"></option>
                        <option value="None">None</option>
                        <option value="Bachelor">Bachelor</option>
                        <option value="Master">Master</option>
                        <option value="PhD">PhD or equivalent</option>
                        <option value="Other">Other</option>
                    </select>
                </p>
              <p>
                    <label for="participantExperience">For how many years have you been doing research since your last degree:</label>
                    <input type = "text" id = "participantExperience" value = "" >
                </p>

                <label for="participantTools">What data analysis tools you commonly use: </label>
                <textarea id = "participantTools" value = "" ></textarea>

        </div>

         <p>
            <br/>
            <br/><input id="demographicsButton" name="demographicsButton" type="button" value="Start experiment" onclick="onStart()" /><br/>
        </p>
        </form>
    </section>
    <section id="taskExplanations" style="display:none">
        <h1>Explanation on the task</h1>
        <p>In each of the following pages, you will be presented with a figure
            describing the results of a simple trial.
            <b>Your task is to answer the question
            <i>"How confident you are that the medication results in a decrease in body weight?"</i>.</b></p>
            <br/>
            <p>Your answer will be given on a continuous scale using a slider (from 1 to 100).
            In order to avoid accidental skipping of the trials,
            the cursor on the slider is hidden until you click the slider. </p>
            <br/>
            <p>There will be four sets of 8 trials, followed by a few questions about the overall
            impressions of the representation styles and the survey in general.
            </p>
        <br/><input id="explanationsButton" type="button" value="Next" onclick="onExplanationsButton()" /><br/>
    </section>
    <section id="explanations-violin2" style="display:none">
        <h1>Representation using discrete t-violin plots</h1>
        <div class="exampleText">


            <h4>What is shown?</h4>

                        <p> In these representations, the figure shows
                            80%, 85%, 90%, 95%, and 99.9% confidence intervals
                            as colored areas. Until 80% CI the color is constant, and it then
                            gradually changes until 99.9% level.
                            The black line is a sample mean.
                            The width of the area is determined by the value of the corresponding density function of the t-distribution
                            used in constructing the CIs. For example, the width of the figure at point x is defined as f((x - sample_mean) / standard_error) / standard_error,
                            where f is the density function of t-distribution with 99 degrees of freedom.</p>
                            <br/>
                                                        <i> Note the y-axis, higher values correspond to larger weight loss.</i>

            <h4>What is a confidence interval (CI)?</h4>
        <p>
            A 95% confidence interval of a mean refers to an interval estimate which,
            if computed for infinitely many independent samples of equal size from the same population,
            would contain the true population mean 95% of time.</p>
            <p> The CI can be also interpreted in terms of
            hypothesis testing as follows:
            A 95% confidence interval presents those values of the true population effect
            which would not lead to the rejection of the null hypothesis when testing against our
            observed mean using t-test with significance level of 0.05.</p>

    <h4>How is the CI computed?</h4>
    <p> The confidence interval for the mean is computed using a sample mean, sample standard deviation,
    sample size and t-distribution. For example assuming sample size of 100, the upper limit of 95% confidence interval is computed as
    x = sample_mean + t * standard_error, where t=1.98 is the critical value from t-distribution with 99 degrees of freedom.</p>


    <h4>Difference from common violin plots</h4>
                <p> Note that violin plot typically describes the estimated probability density function of the data, whereas in this case we visualize the uncertainty regarding
                    the estimation of mean. These figures are also closely related to so called cat's eye plot.</p>

<br/>
<br/><input id="buttonCondition1" type="button" value="Continue the experiment" onclick="onStartCondition(this.id)" />
</div>
<div class="exampleImage">
<img class="Image" src="figures/examples/violin2.png">
</div>



    </section>
    <section id="explanations-ci" style="display:none">
    <h1>Representation using confidence intervals</h1>
        <div class="exampleText">

            <h4>What is shown?</h4>
                <p>In these representations, you are given a graphical representation of a
                    95% confidence interval of the mean (lower and upper whiskers),
                    and the sample mean (black dot).</p>
                    <br/>
                                                <i> Note the y-axis, higher values correspond to larger weight loss.</i>

            <h4>What is a confidence interval (CI)?</h4>
        <p>
            A 95% confidence interval of a mean refers to an interval estimate which,
            if computed for infinitely many independent samples of equal size from the same population,
            would contain the true population mean 95% of time.</p>
            <p> The CI can be also interpreted in terms of
            hypothesis testing as follows:
            A 95% confidence interval presents those values of the true population effect
            which would not lead to the rejection of the null hypothesis when testing against our
            observed mean using t-test with significance level of 0.05.</p>
    <h4>How is the CI computed?</h4>
    <p> The confidence interval for the mean is computed using a sample mean, sample standard deviation,
    sample size and t-distribution. For example assuming sample size of 100, the upper limit of 95% confidence interval is computed as
    x = sample_mean + t * standard_error, where t=1.98 is the critical value from t-distribution with 99 degrees of freedom.</p>


        <br/>
        <br/><input id="buttonCondition2" type="button" value="Continue the experiment" onclick="onStartCondition(this.id)" />
        </div>
        <div class="exampleImage">
        <img class="Image" src="figures/examples/ci.png">
        </div>
    </section>
    <section id="explanations-violin" style="display:none">
        <h1>Representation using t-violin plots</h1>
        <div class="exampleText">


            <h4>What is shown?</h4>

                        <p> In these representations, the figure shows 95%, 95.1%, ..., 99.9% confidence intervals (0.1 percentage point increments)
                            as colored areas. Until 95% CI the color is constant, and it then gradually changes until 99.9% level.
                            The black line is a sample mean.
                            The width of the area is determined by the value of the corresponding density function of the t-distribution
                            used in constructing the CIs. For example, width of the figure at point x is defined as f((x - sample_mean) / standard_error) / standard_error,
                            where f is the density function of t-distribution with 99 degrees of freedom.</p>
                            <br/>
                                                        <i> Note the y-axis, higher values correspond to larger weight loss.</i>

            <h4>What is a confidence interval (CI)?</h4>
        <p>
            A 95% confidence interval of a mean refers to an interval estimate which,
            if computed for infinitely many independent samples of equal size from the same population,
            would contain the true population mean 95% of time.</p>
            <p> The CI can be also interpreted in terms of
            hypothesis testing as follows:
            A 95% confidence interval presents those values of the true population effect
            which would not lead to the rejection of the null hypothesis when testing against our
            observed mean using t-test with significance level of 0.05.</p>

    <h4>How is the CI computed?</h4>
    <p> The confidence interval for the mean is computed using a sample mean, sample standard deviation,
    sample size and t-distribution. For example assuming sample size of 100, the upper limit of 95% confidence interval is computed as
    x = sample_mean + t * standard_error, where t=1.98 is the critical value from t-distribution with 99 degrees of freedom.</p>


    <h4>Difference from common violin plots</h4>
                <p> Note that violin plot typically describes the estimated probability density function of the data, whereas in this case we visualize the uncertainty regarding
                    the estimation of mean. These figures are also closely related to so called cat's eye plot.</p>


<br/>
<br/><input id="buttonCondition3" type="button" value="Continue the experiment" onclick="onStartCondition(this.id)" />
</div>
<div class="exampleImage">
<img class="Image" src="figures/examples/violin.png">
</div>
    </section>
    <section id="explanations-gradient" style="display:none">
        <h1>Representation using gradient plots</h1>
            <div class="exampleText">

                <h4>What is shown?</h4>

                        <p> In these representations,
                            the figure shows 95%, 95.1%, ..., 99.9% confidence intervals (0.1 percentage point increments)
                            as colored areas. Until 95% CI the color is constant, and it then gradually changes until 99.9% level.
                            The black line is a sample mean.
<br/>
                            <i> Note the y-axis, higher values correspond to larger weight loss.</i>
                        </p>

            <h4>What is a confidence interval (CI)?</h4>
        <p>
                A 95% confidence interval of a mean refers to an interval estimate which,
                if computed for infinitely many independent samples of equal size from the same population,
                would contain the true population mean 95% of time.</p>
                <p> The CI can be also interpreted in terms of
                hypothesis testing as follows:
                A 95% confidence interval presents those values of the true population effect
                which would not lead to the rejection of the null hypothesis when testing against our
                observed mean using t-test with significance level of 0.05.</p>
        <h4>How is the CI computed?</h4>
        <p> The confidence interval for the mean is computed using a sample mean, sample standard deviation,
        sample size and t-distribution. For example assuming sample size of 100, the upper limit of 95% confidence interval is computed as
        x = sample_mean + t * standard_error, where t=1.98 is the critical value from t-distribution with 99 degrees of freedom.</p>



<br/>
<br/><input id="buttonCondition4" type="button" value="Continue the experiment" onclick="onStartCondition(this.id)" />
</div>
<div class="exampleImage">
<img class="Image" src="figures/examples/gradient.png">
</div>
    </section>

    <section id="maindiv" style="display:none">
        <!--<h1 id="conditionName"></h1>-->
        <div id="imgdiv">
            <img id="img" class="Image" src=""/>
        </div>
        <div id="slidersdiv">
            <div class="slidecontainer">
     <br/><br>
<p>
A random sample of 50 adults from Sweden were prescribed a new medication for one week.
Another random sample of 50 adults from Sweden were assigned to a control group and given a placebo.
Based on the information on the screen, <b> how confident are you that the medication
    decreases the body weight?</b> <i> Note the y-axis, higher values correspond to larger weight loss.</i> </p>
<br/><br/>
    <p>
The leftmost position of the slider corresponds to the case "I have zero confidence in claiming an effect",
 whereas the rightmost position of the slider corresponds to the case
 "I am fully confident that there is an effect."</p>
 <br/><br>

         <center>    <span>Zero confidence</span>
            <input type="range" min="1" max="100" value="1" class="slider2" id="slider1">
            <span>Full confidence</span></center>
            </div>
             <div>
                 <center><button id="Next" onClick="onNext()">Next</button></center>
             </div>
                  <br/><br>
                  <hr>
            <div class = "reminder">

                </div>
            <div id="caption-violin2" class = "explanatoryText"  style="display:none">
                <p> The figure shows 80%, 85%, 90%, 95%, and 99.9% confidence intervals
                as colored areas. Until 80% CI the color is constant, and it then
                gradually changes until 99.9% level.
                    The black line is a sample mean.
                    The width of the area is determined by the value of the corresponding density function of the t-distribution
                    used in constructing the CIs.</p>
            </div>
            <div id="caption-ci" class = "explanatoryText"  style="display:none">
                <p>The figure shows 95% confidence interval of the mean (lower and upper whiskers),
                and the sample mean (black dot). </p>
            </div>

            <div id="caption-violin" class = "explanatoryText"  style="display:none">
                <p> The figure shows 95%, 95.1%, ..., 99.9% confidence intervals (0.1 percentage point increments)
                    as colored areas. Until 95% CI the color is constant, and it then gradually changes until 99.9% level.
                    The black line is a sample mean.
                    The width of the area is determined by the value of the corresponding density function of the t-distribution
                    used in constructing the CIs.</p>
            </div>

            <div id="caption-gradient" class = "explanatoryText"  style="display:none">
                <p> The figure shows 95%, 95.1%, ..., 99.9% confidence intervals (0.1 percentage point increments)
                    as colored areas. Until 95% CI the color is constant, and it then gradually changes until 99.9% level.
                    The black line is a sample mean.</p>
            </div>

        </div>
    </section>

    <section id="subjective" style="display: none">
    <!--<section id="subjective">-->
        <h3>Subjective Assesments</h3>

        <p>
            Thank you for your participation so far. Before the end of the experiment,
            we would like to ask you to give us some
            feedback of the visualization you have seen in this experiment.<br/>
        </p>

        <!--TODO fix the layout later -->
        <form>
        <div class="feedback">
            <table class="feedback">
                <tr>
                    <td><img class="reminderImage" src="figures/examples/violin2.png"></td>
                    <td>
                        In your opinion, what are the limitations and benefits of this format.
                        <br/>
                        <textarea id = "feedbackviolin2" value = "" ></textarea><br/>
                    </td>
                    <td>
                        Rank it from 1 (preferred) to 4 (least preferred).
                        You can, in case it's hard to decide between two techniques, rank both with the same number.<br/>
                        <select id="rankviolin2">
                            <option value="0"></option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </td>
                </tr>
            </table>


            <table>
                <tr>
                    <td><img class="reminderImage" src="figures/examples/ci.png"></td>
                    <td>
                        In your opinion, what are the limitations and benefits of this format.
                        <br/>
                        <textarea id = "feedbackci" value = "" ></textarea><br/>
                    </td>
                    <td>
                        Rank it from 1 (preferred) to 4 (least preferred). You can, in case it's hard to decide between two techniques, rank both with the same number.<br/>
                        <select id="rankci">
                            <option value="0"></option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </td>
                </tr>
            </table>


            <table>
                <tr>
                    <td><img class="reminderImage" src="figures/examples/gradient.png"></td>
                    <td>
                        In your opinion, what are the limitations and benefits of this format.
                        <br/>
                        <textarea id = "feedbackgradient" value = "" ></textarea><br/>
                    </td>
                    <td>
                        Rank it from 1 (preferred) to 4 (least preferred). You can, in case it's hard to decide between two techniques, rank both with the same number.<br/>
                        <select id="rankgradient">
                            <option value="0"></option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </td>
                </tr>
            </table>

            <table>
                <tr>
                    <td><img class="reminderImage" src="figures/examples/violin.png"></td>
                    <td>
                        In your opinion, what are the limitations and benefits of this format.
                        <br/>
                        <textarea id = "feedbackviolin" value = "" ></textarea><br/>
                    </td>
                    <td>
                        Rank it from 1 (preferred) to 4 (least preferred). You can, in case it's hard to decide between two techniques, rank both with the same number.<br/>
                        <select id="rankviolin">
                            <option value="0"></option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </td>
                </tr>
            </table>

        </div>

        <p>If you have any additional comments, please leave them here.</p>
        <br/>
            <textarea id = "feedbackcomments" value = "" ></textarea><br/>

        <br/>
        <br/><input id="subjectiveButton" name="subjectiveButton" type="button" value="Send Feedback" onclick="onSubjective()" /><br/>
        </form>
    </section>


    <section id="finaldiv" style="display:none">
        <h1>Thank you for your participation!  </h1>

    </section>


    <script>
        var slider1 = document.getElementById("slider1");
        //var output = document.getElementById("demo");
        var image = document.getElementById("img");
        var currentTrialIndex = 0 ;

        var orderConditions = new Array();
        var orderTrial ;
        var currentConditionIndex = 0 ;
        var answers = new Array();
        var isFinished = false ;
        //var conditionName = document.getElementById("conditionName");

        var DebugMode = 1 //Set to 1 if you want to enable fast debugging throught the code.

        var nbOfTrials = 8 ;
        // get participant id
        // need to use callback to circumvent async
        var pid = null;
        function ajaxCallBack(result){
          pid = result;
        }




        var parameter1value = 0

        var firstImageDisplay = true

        var isSliderVisible = false

        if (DebugMode == 1) console.log("Slider = "+slider1.className)





        /*
         ******************************************************************************************************************************************
         ******************************************************************************************************************************************

            All functions called to initialise values
            Utility functions in a way

         ******************************************************************************************************************************************
         ******************************************************************************************************************************************
        */

        // Need to implement a Latin Square for counter-balancing order
        // ABCD
        // BADC
        // CDAB
        // DCBA

        function getConditionOrder(){

            if(pid%4 == 0){
                orderConditions.push("violin2")
                orderConditions.push("ci")
                orderConditions.push("violin")
                orderConditions.push("gradient")
            }
            else if(pid%4 == 1){
                orderConditions.push("ci")
                orderConditions.push("violin2")
                orderConditions.push("gradient")
                orderConditions.push("violin")
            }
            else if(pid%4 == 2){
                orderConditions.push("violin")
                orderConditions.push("gradient")
                orderConditions.push("violin2")
                orderConditions.push("ci")
            }
            else{
                orderConditions.push("gradient")
                orderConditions.push("violin")
                orderConditions.push("ci")
                orderConditions.push("violin2")
            }
            if (DebugMode == 1) console.log(orderConditions)
        }

        function shuffle(array) {
            // Now we want to pseudo-randomly shuffle this array
            // This is not supported by JS, so we use David Bau's seedrandom()
            // https://github.com/davidbau/seedrandom

            // Use "new" to create a local prng without altering Math.random.
            var seed = pid*100+currentConditionIndex.toString();
            var myrng = new Math.seedrandom(seed);


            var currentIndex = array.length, temporaryValue, randomIndex;

            // While there remain elements to shuffle...
            while (0 !== currentIndex) {

                // Pick a remaining element...
                randomIndex = Math.floor(myrng() * currentIndex);
                currentIndex -= 1;

                // And swap it with the current element.
                temporaryValue = array[currentIndex];
                array[currentIndex] = array[randomIndex];
                array[randomIndex] = temporaryValue;
            }

            return array;
        }


        function getTrialOrder(){
            // This function is called for each different condition
            // We cannot counterbalance each trial, so we need to randomize and make it reproducible.
            // We use a seed to generate the random order.
            orderTrial = new Array()
            for(i = 1 ; i < nbOfTrials+1 ; i++){
                orderTrial.push(i)
            }

            orderTrial = shuffle(orderTrial)
            if (DebugMode == 1) console.log("OrderTrial ="+orderTrial);

        }

        function startNewCondition(){
            var condition = orderConditions[currentConditionIndex];
            document.getElementById("maindiv").style.display = "none" ;
            showConditionExplanations(condition);
            getTrialOrder();
        }

        function showConditionExplanations(condition){
            var sectionid = "explanations-"+orderConditions[currentConditionIndex]
            document.getElementById(sectionid).style.display = "block";
            for(i=0 ; i < 4 ; i++) {
                document.getElementById("caption-"+orderConditions[i]).style.display = "none";
            }
            var captionid = "caption-"+orderConditions[currentConditionIndex]
            document.getElementById(captionid).style.display = "block";

            /*if(condition == 1){
                document.getElementById("explanationsPvalues").style.display = "block";
            }
            if(condition == 2){
                document.getElementById("explanationsConfidence").style.display = "block";
            }
            if(condition == 3){
                document.getElementById("explanationsViolin").style.display = "block";
            }
            if(condition == 4){
                document.getElementById("explanationConditionFinal").style.display = "block";
            }*/
        }

        function showMainExperiment(){
            var sectionid = "explanations-"+orderConditions[currentConditionIndex]
            if (DebugMode == 1) console.log("Section ID to be made visible = "+sectionid)
            document.getElementById(sectionid).style.display = "none";
            //conditionName.innerHTML=orderConditions[currentConditionIndex];
            document.getElementById("maindiv").style.display = "block" ;
            if(firstImageDisplay){
                if (DebugMode == 1) console.log("firstimage");
                changeStimuli();
                firstImageDisplay = false
            }

        }



        /*
        ******************************************************************************************************************************************
        ******************************************************************************************************************************************

        All functions linked to button presses

        ******************************************************************************************************************************************``
        ******************************************************************************************************************************************
        */

        function onStartCondition(id){
            if (DebugMode == 1) console.log("Start condition "+orderConditions[currentConditionIndex])
            /*var button = document.getElementById(id)
            var bestdiv = document.getElementById("besttechniquediv");
            var section = button.parentNode ;
            section.parentNode.removeChild(section);*/
            showMainExperiment();
            topFunction()

        }

        function onConsent(){

            document.getElementById("initialdiv").style.display = 'block'
            document.getElementById("consent").style.display = 'none'
            topFunction()
        }


        function onStart(){
            var obj = {};
            obj.previous = document.getElementById("previousStudy").value
            obj.age = document.getElementById("participantAge").value
            obj.expertise = document.getElementById("participantExpertise").value
            obj.level = document.getElementById("participantLevel").value
            obj.experience = document.getElementById("participantExperience").value
            obj.tools = document.getElementById("participantTools").value

            if(DebugMode == 0 && (obj.previous == "null"  || obj.age == "" || obj.expertise == "" ||
            obj.level == "null" || obj.experience == "" || obj.tools == "") ){
                alert("Please fill in all the fields")
            } else{
                $.ajax({
                  url: "initial_survey.php",
                  type: "POST",
                  data : {
                    results : JSON.stringify(obj)
                  },
                  success: function(response) {
                      ajaxCallBack(response);
                      getConditionOrder();
                  },
                  error: function(request, text, error) {
                    alert(error);
                    if (DebugMode == 1) console.log(text);
                    if (DebugMode == 1) console.log("didn't work!");
                  }
                });
                //loadTrialOrder();

                /*Once this is over, we make the PID block disappear and the rest appear*/
                /*document.getElementById("maindiv").style.display = "block";
                document.getElementById("initialdiv").style.visibility = "hidden";*/
                var initialDiv = document.getElementById("initialdiv");
                initialDiv.parentNode.removeChild(initialDiv);
                document.getElementById("taskExplanations").style.display = 'block';
            }
            topFunction()

        }

        function onExplanationsButton(){
            document.getElementById("taskExplanations").style.display = "none";
            startNewCondition()
        }


        function onNext(){
            if(isSliderVisible == false && DebugMode == 0){
                return
            }
            log();
            currentTrialIndex ++ ;
            if(currentTrialIndex >= nbOfTrials){
                currentTrialIndex = 0 ;
                currentConditionIndex ++ ;
                if(currentConditionIndex >= 4){
                    isFinished = true ;
                    onFinished();
                    return ;
                }

                startNewCondition();
                updateInterface();
                resetValues();
                return ;
            }
            resetValues();
            updateInterface();
        }


        //TODO save the ranking data
        function onSubjective(){
            var labels = ["violin2", "ci", "violin", "gradient", "comments"]
            var feedback = new Array()
            var rank = new Array()
            /* We check that all subjective feedback is entered*/
            for(var i = 0 ; i < 5 ; i++){
                feedback.push(document.getElementById("feedback"+labels[i]).value)
                if(i < 4 && feedback[i]==''){
                    alert("Please fill in all the fields.");
                    return ;
                }
            }
            /*We check that all ranking is in*/
            for(var i = 0 ; i < 4 ; i++){
                rank.push(document.getElementById("rank"+labels[i]).value)
                if(rank[i] == 0){
                    alert("Please rank all techniques.");
                    return ;
                }
            }
            var obj = {};
            obj.labels = labels;
            obj.feedback = feedback;
            obj.rank = rank;
            $.ajax({
              url: "end_survey.php",
              type: "POST",
              data : {
                pid : pid,
                results : JSON.stringify(obj)
              },
              success: console.log("saving end survey worked!"),
              error: function(request, text, error) {
                alert(error);
                if (DebugMode == 1) console.log(text);
                if (DebugMode == 1) console.log("didn't work!");
              }
            });
            document.getElementById("subjective").style.display = 'none'
            document.getElementById("finaldiv").style.display = 'block'
            topFunction()
        }



        slider1.oninput = function() {
            //output.innerHTML = this.value;
            parameter1value = this.value;
            //changeImage();
            if(DebugMode == 1){
                console.log("On Slider Input, value = "+this.value)
                console.log("UpdateSlider")
            }

            slider1.className = "slider"
            isSliderVisible = true ;
            //feedback1.innerHTML = "Abstraction Level = "+parameter1value
        }

        /*
         ******************************************************************************************************************************************
         ******************************************************************************************************************************************

            All functions for resetting values and changing the interface

         ******************************************************************************************************************************************
         ******************************************************************************************************************************************
        */

        function resetValues(){
            parameter1value = 50
            slider1.value = 50
            slider1.className = "slider2"
            isSliderVisible = false ;
        }

        // Called whenever a button is clicked to remove all scrolling actions
        function topFunction() {
            document.body.scrollTop = 0; // For Safari
            document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
        }

        function updateInterface(){
            if(isFinished){
                //TODO
                return ;
            }
            updateTextAndButtons();
            if (DebugMode == 1) console.log("Interface done updating")
            changeStimuli();
            topFunction()
        }

        function updateTextAndButtons(){
            if(isFinished){
                //TODO
                return ;
            }
            //conditionName.innerHTML=orderConditions[currentConditionIndex];
        }

        function changeStimuli(){
            var imageName ="figures/"+orderConditions[currentConditionIndex]+"/"+orderTrial[currentTrialIndex]+"_50.png"
            if (DebugMode == 1) console.log("Image name ="+imageName)
            image.src = "figures/Mask.png";
            setTimeout(function() {
            	image.src = imageName ;
        	}, 200);

        }


        /*
         ******************************************************************************************************************************************
         ******************************************************************************************************************************************

            All functions called at the end of the experiment

         ******************************************************************************************************************************************
         ******************************************************************************************************************************************
        */

        function onFinished(){
            document.getElementById("maindiv").style.display = "none";
            document.getElementById("subjective").style.display = "block"
            saveToCSV();
        }




        //TODO save answers to a file (not csv though)
        function saveToCSV(){

            if (DebugMode == 1) console.log("saving stuff");

            $.ajax({
              url: "save_answers.php",
              type: "POST",
              data : {
                pid : pid,
                results : JSON.stringify(answers)
              },
              success: console.log("saving answers worked!"),
              error: function(request, text, error) {
                alert(error);
                if (DebugMode == 1) console.log(text);
                if (DebugMode == 1) console.log("didn't work!");
              }
            });

                    //var hiddenElement = document.createElement('a');
          //  hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
          //  hiddenElement.target = '_blank';
          //  hiddenElement.download = pid+'.csv';
          //  hiddenElement.click();

        }


        /*
         ******************************************************************************************************************************************
         ******************************************************************************************************************************************

            All functions to log

         ******************************************************************************************************************************************
         ******************************************************************************************************************************************
        */



        function log(){
            var toLog = ""+pid+","+orderConditions[currentConditionIndex]+","+orderTrial[currentTrialIndex].toString()+","+parameter1value
            if (DebugMode == 1) console.log("Is logged = "+toLog);
            answers.push(toLog);
        }


    </script>

</body>


</html>
